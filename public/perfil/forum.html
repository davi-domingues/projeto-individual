<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Perfil - Ler&Saber</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">


</head>

<body class="perfil" onload="atualizarFeed()">
    
    <header>

    </header>

    <main class="forum">
        <section class="section flex">
            <div class="navbar flex">
                <div class="profile flex">
                    <!-- <div id="perfilSession"></div> -->
                    <div class="user flex">
                        <div class="icon flex">
                            <i class="fa-solid fa-user icone"></i>
                        </div>
                        <div class="flex info">
                            <h3 id="nomeSession">Nome</h3>
                            <span id="emailSession">email@email.com</span>
                            <span id="usernameSession">user_name</span>
                            <i class="fa-solid fa-gear config" onclick="abrirModal(modal_config)"></i>
                        </div>
                    </div>
                </div>
                <div class="toolsList flex">
                    <div id="homeLink" class="link-button flex">
                        <i class="fa-solid fa-house icone"></i>
                        <h3>Home Page</h3>
                    </div>
                    <div id="diarioLink" class="link-button flex">
                        <i class="fa-solid fa-book icone"></i>
                        <h3>Diário de Leitura</h3>
                    </div>
                    <div id="dashboardLink" class="link-button flex">
                        <i class="fa-solid fa-chart-line icone"></i>
                        <h3>Dashboard</h3>
                    </div>
                    <div id="forumLink" class="link-button flex">
                        <i class="fa-solid fa-comments icone"></i>
                        <h3>Fórum</h3>
                    </div>
                    <div id="relogioLink" class="link-button flex">
                        <i class="fa-solid fa-clock icone"></i>
                        <h3>Sessão de Concentração</h3>
                    </div>
                    <div id="sugestoesLink" class="link-button flex">
                        <i class="fa-solid fa-robot icone"></i>
                        <h3>Sugestões</h3>
                    </div>
                </div>
                <div class="options flex">
                    <div id="sairLink" class="link-button flex">
                        <i class="fa-solid fa-right-from-bracket icone"></i>
                        <h3>Sair</h3>
                    </div>
                </div>
            </div>
            <div class="home flex">
                <div class="title">
                    <h1>Fórum</h1>
                </div>
                <div id="pagina_topicos" class="tela_exibicao flex">
                    <div class="main flex">
                        <div class="box flex" id="exibir_topicos">
                            <h3>
                                Tópicos
                            </h3>
                            <div id="lista_foruns" class="lista scroll"></div>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="flex" id="buttons_inicial" style="display: flex;">
                            <span class="button-container"><button onclick="abrirModal(modal_novoTopico)">Abrir novo tópico</button></span>
                        </div>
                    </div>
                    <dialog id="modal_novoTopico">
                        <i class="fa-solid fa-circle-xmark icon" onclick="fecharModal(modal_novoTopico)"></i>
                        <form id="form_topico" method="dialog" onsubmit="">
                            <label>
                                Título do tópico:
                                <input name="ipt_topico" id="ipt_topico" maxlength="45" type="text">
                            </label>
                            <i class="fa-solid fa-paper-plane icon" onclick="publicarTopico()"></i>
                        </form>
                    </dialog>
                </div>
                <div id="pagina_comentario" class="tela_exibicao flex"
                style="display: none;">
                    <div class="main flex">
                        <div class="box flex" id="exibir_livros">
                            <h3 id="titulo_topico">
                                Comentários
                            </h3>
                            <div id="lista_comentarios" class="lista scroll"></div>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="flex" id="buttons_inicial" style="display: flex;">
                            <span class="button-container"><button onclick="voltar()">Voltar</button></span>
                            <span class="button-container"><button onclick="abrirModal(modal_novoComentario)">Novo Comentario</button></span>
                        </div>
                    </div>
                    <dialog id="modal_novoComentario">
                        <i class="fa-solid fa-circle-xmark icon" onclick="fecharModal(modal_novoComentario)"></i>
                        <form id="form_novoComentario" method="dialog" onsubmit="">
                            <label>
                                Seu comentário:
                                <textarea name="ipt_novoComentario" id="ipt_novoComentario" cols="50" rows="5" style="resize: none" maxlength="280"></textarea>
                            </label>
                            <i class="fa-solid fa-paper-plane icon" onclick="publicarComentario()"></i>
                        </form>
                    </dialog>
                    <dialog id="modal_editarComentario">
                        <i class="fa-solid fa-circle-xmark icon" onclick="fecharModal(modal_editarComentario)"></i>
                        <form id="form_editarComentario" method="dialog" onsubmit="">
                            <label>
                                Edite seu comentário:
                                <textarea name="ipt_editComentario" id="ipt_editComentario" cols="50" rows="5" style="resize: none" maxlength="280"></textarea>
                            </label>
                            <i id="btn_editarComentario" class="fa-solid fa-paper-plane icon" onclick=""></i>
                        </form>
                    </dialog>
                </div>
            </div>
                <div class="help-tag" onclick="abrirModal(forum_help)">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <dialog id="forum_help">
                <div>
                    <i class="fa-solid fa-circle-xmark icon close-button" onclick="fecharModal(forum_help)"></i>
                    <div class="frase-help">Nessa página você pode interagir com outros usuário do site, crie um novo tópico ou comente em algum que já exista.<br>Lembre-se de ser sempre respeitoso e amigável!</div>
                </div>
            </dialog>
            <dialog id="modal_confirma">
                <div>
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span id="text-aviso">Você tem certeza que quer continuar com essa ação?</span>
                    <span class="button-container">
                        <button id="button_confirma">Confirmar</button>
                        <button onclick="fecharModal(modal_confirma)">Cancelar</button>
                    </span>
                </div>
            </dialog>
        </section>
        <dialog id="modal_config">
            <div class="options-main flex">
                <i class="fa-solid fa-circle-xmark icon close-button" onclick="fecharModal(modal_config)"></i>
                <h3>Opções</h3>
                <div class="button-container">
                    <button onclick="confirmarExecucao('reiniciarConta()')">Reiniciar conta</button>
                    <button onclick="confirmarExecucao('deletarConta()')">Deletar conta</button>
                </div>
            </div>
        </dialog>
        <!-- <dialog id="modal_confirma">
            <div>
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span id="text-aviso">Você tem certeza que quer continuar com essa ação?</span>
                <span class="button-container">
                    <button id="button_confirma">Confirmar</button>
                    <button onclick="fecharModal(modal_confirma)">Cancelar</button>
                </span>
            </div>
        </dialog> -->
    </main>

    <footer class="footer flex">
        <p class="flex">
            <h4>Feito com amor por Davi Domingues &hearts; SPTech &copy; 2025</h4><span class="version">v1.0.0</span>
        </p>
        <span class="ref">Imagens Copyright &copy; 2010-2025 Freepik Company S.L. Todos os direitos reservados.</span>
    </footer>

</body>

</html>

<script src="../js/redirector.js"></script>
<script src="../js/onloadPerfil.js"></script>
<script src="../js/settings.js"></script>
<script src="../js/openClose.js"></script>

<script>
    function publicarTopico() {
        const idUsuario = sessionStorage.ID_USUARIO;
        const topico = ipt_topico.value;
        
        if (idUsuario == undefined) {
            alert('Erro na sessão, logue-se novamente');
            window.location.href = '/'
            return false;
        };
        if (topico.length < 5) {
            alert('Insira um tópico válido antes de postar');
            return false;
        };

        fetch("/forum/criarForum", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario,
                topicoServer: topico
            }),
        })
        .then(function (resposta) {
            console.log("resposta: ", resposta);
            console.log(resposta.body);

            if (resposta.ok) {
                alert('Tópico iniciado com sucesso!');
                atualizarFeed();
                form_topico.submit();
                ipt_topico.value = '';
            } else {
                throw "Houve um erro ao tentar realizar o cadastro!";
            };
        })
        .catch(function (erro) {
            console.log(erro)
            if (erro.status === 500) {alert('Site deconectado do servidor')};
            console.log(`#ERRO ${erro}`)
        });
    };

    function publicarComentario() {
        const idForum = sessionStorage.TOPICO_ATUAL;
        const idUsuario = sessionStorage.ID_USUARIO;
        const comentario = ipt_novoComentario.value;

        if (idUsuario == undefined) {
            alert('Erro na sessão, logue-se novamente');
            window.location.href = '/'
            return false;
        };
        if (idForum == undefined) {
            alert('Erro na seleção do tópico, escolha outro para comentar');
            voltar();
            return false;
        };
        if (comentario.length < 5) {
            alert('Insira um comentário válido antes de postar');
            return false;
        };

        fetch("/forum/postarComentario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idForumServer: idForum,
                idUsuarioServer: idUsuario,
                comentarioServer: comentario
            }),
        })
        .then(function (resposta) {
            console.log("resposta: ", resposta);
            console.log(resposta.body);

            if (resposta.ok) {
                alert('Comentario postado com sucesso!');
                listarComentarios(sessionStorage.TOPICO_ATUAL)
                form_novoComentario.submit();
                ipt_novoComentario.value = '';
            } else {
                throw "Houve um erro ao tentar realizar o cadastro!";
            };
        })
        .catch(function (erro) {
            console.log(erro)
            if (erro.status === 500) {alert('Site deconectado do servidor')};
            console.log(`#ERRO ${erro}`)
        });
    };

    function atualizarFeed() {
        fetch("/forum/listarForuns")
            .then((resposta) => {
                console.log(resposta)
                lista_foruns.innerHTML = '';
                if (resposta.status == 204) {
                    const div = lista_foruns.appendChild(document.createElement("div"));
                    div.textContent = `Ainda não existe nenhum tópico. Seja o primeiro a adicionar um!`;
                }
                if (resposta.status == 200) {
                    resposta.json().then((foruns) => {
                        foruns.forEach((forum) => {
                            let dataFormatada = new Date(forum.dtCriacao);
                            dataFormatada = dataFormatada.toLocaleDateString('pt-BR');

                            let div = lista_foruns.appendChild(document.createElement("div"));
                            div.classList.add("forum");

                            let head = div.appendChild(document.createElement("div"));
                            head.classList.add("head");
                            head.innerHTML = `
                            <i class="fa-solid fa-user icon"></i>
                            ${forum.nome} @ ${forum.username} - (Publicado: ${dataFormatada})
                            `

                            let topico = div.appendChild(document.createElement("div"));
                            topico.classList.add("topico")
                            topico.setAttribute("onclick", `listarComentarios(${forum.idForum})`);
                            topico.textContent = `${forum.topico}`

                            let foot = div.appendChild(document.createElement("div"));
                            foot.classList.add("foot");
                            if (sessionStorage.ID_USUARIO == forum.idUsuario) {     
                                foot.innerHTML += `<i class="fa-solid fa-trash-can icon" onclick="confirmarExecucao('removerTopico(${forum.idForum})')"></i>`
                            }
                        })
                    })
                }
            })
            .catch((resposta) => {
                console.log(`#ERRO: ${resposta}`)
            })
        ;
    }

    function removerTopico(idForum) {
        fecharModal(modal_confirma);
        fetch(`/forum/excluirForum/${idForum}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                window.alert("Post deletado com sucesso!");
                atualizarFeed();
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    };

    function removerComentario(idComentario) {
        fecharModal(modal_confirma);

        const idUsuario = sessionStorage.ID_USUARIO;
        const idForum = sessionStorage.TOPICO_ATUAL;

        fetch(`/forum/excluirComentario/${idUsuario}/${idForum}/${idComentario}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                window.alert("Post deletado com sucesso!");
                listarComentarios(idForum);
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    };

    function abrirEditor(idComentario, texto) {
        console.log(idComentario)
        console.log(texto)
        btn_editarComentario.setAttribute("onclick", `editarComentario(${idComentario})`);
        ipt_editComentario.value = texto;
        abrirModal(modal_editarComentario);

    }

    function editarComentario(idComentario) {
        const idUsuario = sessionStorage.ID_USUARIO;
        const idForum = sessionStorage.TOPICO_ATUAL;
        const comentario = ipt_editComentario.value

        fetch(`/forum/editarComentario/${idUsuario}/${idForum}/${idComentario}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                comentarioServer: comentario
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                window.alert("Post editado com sucesso!");
                btn_editarComentario.setAttribute("onclick", '');
                ipt_editComentario.value = '';
                listarComentarios(idForum);
                fecharModal(modal_editarComentario)
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    };

    function listarComentarios(idForum) {
        sessionStorage.TOPICO_ATUAL = idForum;
        desabilitar(pagina_topicos);
        habilitar(pagina_comentario);

        fetch(`/forum/listarComentarios/${idForum}`)
            .then((resposta) => {
                console.log(resposta)
                lista_comentarios.innerHTML = '';
                if (resposta.status == 204) {
                    const div = lista_comentarios.appendChild(document.createElement("div"));
                    div.textContent = `Ainda não existe nenhum comentário aqui. Seja o primeiro a adicionar um!`;
                }
                if (resposta.status == 200) {
                    resposta.json().then((comentarios) => {
                        comentarios.forEach((comentario) => {
                            titulo_topico.textContent = comentario.topico;
                            const id = comentario.idComentario;

                            let dataFormatada = new Date(comentario.dtPostagem);
                            dataFormatada = dataFormatada.toLocaleDateString('pt-BR');

                            let div = lista_comentarios.appendChild(document.createElement("div"));
                            div.classList.add("forum");

                            let head = div.appendChild(document.createElement("div"));
                            head.classList.add("head");
                            head.innerHTML = `
                            <i class="fa-solid fa-user icon"></i>
                            ${comentario.nome} @ ${comentario.username} - (Publicado: ${dataFormatada})
                            `

                            let topico = div.appendChild(document.createElement("div"));
                            topico.classList.add("topico")
                            topico.textContent = `${comentario.comentario}`

                            let foot = div.appendChild(document.createElement("div"));
                            foot.classList.add("foot");
                            // conteudo.innerHTML += `<br>
                            // ${comentario.curtidas}<i id="like_vazio${id}" class="fa-regular fa-thumbs-up" style="display: flex" onclick="atualizarCurtida(${id}, 'like', 'curtir')"></i>
                            // <i id="like_cheio${id}" class="fa-solid fa-thumbs-up" style="display: none" onclick="atualizarCurtida(${id}, 'like', 'descurtir')"></i>
                            // `
                            if (sessionStorage.ID_USUARIO == comentario.id) {
                                foot.innerHTML += `
                                <i class="fa-solid fa-trash-can icon" onclick="confirmarExecucao('removerComentario(${id})')"></i>
                                <i class="fa-solid fa-pen-to-square icon" onclick="abrirEditor(${id}, '${comentario.comentario}')"></i>
                                `
                            }
                        })
                    })
                }
            })
            .catch((resposta) => {
                console.log(`#ERRO: ${resposta}`)
            })
        ;
    };

    function voltar() {
        titulo_topico.textContent = 'Comentários';
        sessionStorage.removeItem('TOPICO_ATUAL');
        desabilitar(pagina_comentario);
        habilitar(pagina_topicos);
    };

    function atualizarCurtida(id, button, acao) {
        if (acao == 'curtir') {
            desabilitar(document.getElementById(`${button}_vazio${id}`));
            habilitar(document.getElementById(`${button}_cheio${id}`));
        };
        if (acao == 'descurtir') {
            desabilitar(document.getElementById(`${button}_cheio${id}`));
            habilitar(document.getElementById(`${button}_vazio${id}`));
        };

        const idUsuario = sessionStorage.ID_USUARIO;
        const idForum = sessionStorage.TOPICO_ATUAL;
        const idComentario = id;

        fetch(`/forum/atualizarCurtidas/${idUsuario}/${idForum}/${idComentario}/${acao}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                listarComentarios(idForum);
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw (resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    };
</script>